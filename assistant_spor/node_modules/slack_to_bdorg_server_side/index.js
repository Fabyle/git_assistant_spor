/**
 * New node file
 */

// ------------------- read the properties file
var PropertiesReader = require('properties-reader');
var properties = PropertiesReader('./properties');

var port_web_socket = properties.get('main.port.web_socket');
console.log ("la configuration de 'main.port.web_socket est : "+port_web_socket);


//------------------- Import
var request = require("request");
var app = require('express')();
var http = require('http').Server(app);
var io = require('socket.io')(http);
var fs = require('fs');


var the_only_socket_supported;
//------------------- listen on connections
io.on('connection', function (socket){
	console.log('connection');
	
	the_only_socket_supported = socket;
	
	
	the_only_socket_supported.on("BDORG",function(from, message){
		// mettre ici l'envoi au slack bot
		console.log("recu du client : "+message);
	});
	
});

//------------------- listen on connections
var emit_to_bdorg = function(message){
	console.log ("appel de la bdorg");
	if (the_only_socket_supported != undefined ){
		the_only_socket_supported.emit('BDORG', 'slackBot', "/utilisateurs/search?lb_nom=lemoine");
	}
	else {
		console.log ("la socket est indéfini");
	}
}

//---- test
app.get("/",function(req,res){
	fs.readFile('./index.html', 'utf-8', function(error, content) {
        res.writeHead(200, {"Content-Type": "text/html"});
        res.end(content);
	})
});

//------------------- Démarrage du serveur
http.listen(port_web_socket, function () {
	  console.log('Listening on : '+port_web_socket);
	});


//------------------- les exports
exports.emit_to_bdorg = emit_to_bdorg;
